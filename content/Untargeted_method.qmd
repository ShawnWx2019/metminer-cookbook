# Untargeted metabolomics data process.

## Introduce

This Shiny application is developed based on the tidyMass package, specifically designed for the analysis of non-targeted/targeted metabolomics data. Dr. Xiaotao Shen's tidyMass is an excellent open-source software tailored for metabolomics data processing. It adheres to the tidyverse development philosophy, significantly enhancing code readability. Additionally, the newly added **`mass_dataset`** object makes the metabolomics data analysis process more transparent and reproducible.

To make tidyMass accessible to non-programmers in the field of metabolomics research, we developed this Shiny application. We integrated data visualization capabilities into the downstream analysis workflow to facilitate a more intuitive observation and presentation of the analysis results. Considering hardware limitations, we recommend using this Shiny app when the number of samples is fewer than 30.

|                        |  HPC_tidymass   | MDAtoolkits-interactive ShinyAPP |
|:----------------------:|:---------------:|:--------------------------------:|
| Programming Experience |       yes       |                no                |
|   Number of Samples    |       ≥30       |               \<30               |
|      Flexibility       |       Low       |               High               |
|     Interactivity      |       Low       |               High               |
|         speed          |      Fast       |               Slow               |
|         System         | Ubuntu / CentOS |           Win / MacOS            |

## Usage of HPC_tidymass

![](https://img.shields.io/badge/Ubuntu-20.04-greenyellow){style="float: left"} <br>

### 1. Parameters

``` {style="color:black; background-color:#F8F8FF"}
hpc-runTidymass -h
Tidymass pipeline part1. Date transform ,peak picking and annotation
Usage:
-------------------------------
hpc-runTidymass [-i input] [-t type] [-s sample_info] [-g heterogeneous] [-c column]
-------------------------------
Author Shawn Wang (shawnwang2016@126.com)
-------------------------------

Date Wed Nov 29, 2023
-------------------------------

Version V.0.0.1
-------------------------------

Description
-------------------------------

[-i]:input,   The file path of .raw data
[-t]:type,  The type of ion model, 1: NEG+POS in one file, 2: NEG and POS in differnet files, default: 1
[-g]:heterogeneous,  samples from different tissues(or species) or not, yes | no, default : no
[-s]:sample_info,  sample information. see tidymass manual
[-c]:column,  rp or hilic, default: rp
```

### 2. Data Preparation

#### **2.1 Sample Information**

The sample information must include at least the following five columns:

-   **sample_id**: Sample ID, a unique identifier for each sample.

-   **injection_order**: Sample injection order, which records the sequence of sample processing in the experiment.

-   **class**: Sample classification, which can include types such as Blank (blank samples), QC (quality control samples), or Subject (experimental samples).

-   **group**: Group information used to differentiate sample populations, such as case (case group) or control (control group).

-   **batch**: Batch effect information, which marks the batch to which a sample belongs, such as 1, 2, 3, etc.

For more details on sample information, you can visit the TidyMass official website.

| sample_id | injection.order |  class  |  group  | batch |
|:---------:|:---------------:|:-------:|:-------:|:-----:|
|   QC_01   |        1        |   QC    |   QC    |   1   |
|   QC_02   |        2        |   QC    |   QC    |   1   |
|   S_01    |        3        | Subject | Subject |   1   |
|   S_02    |        4        | Subject | Subject |   1   |
|   S_03    |        5        | Subject | Subject |   1   |
|   S_04    |        6        | Subject | Subject |   1   |
|   QC_07   |        7        |   QC    |   QC    |   1   |
|   QC_08   |        8        |   QC    |   QC    |   1   |
|   S_05    |        9        | Subject | Subject |   1   |
|   S_06    |       10        | Subject | Subject |   1   |

#### **2.2 .raw file**

The .raw file contains post-run data, including two subfolders: "NEG" and "POS." Both of these subfolders contain quality control (QC) files and sample files. The file naming convention is as follows:

-   Quality control files: Begin with "QC\_."

-   Sample files: Begin with "S\_."

The file naming and structure are as follows:

``` {style="color:black; background-color:#F8F8FF"}
32.CH/
├── cw_methodt_mrm_chenhui.xlsx
├── NEG
│   ├── QC_01.raw
│   ├── QC_02.raw
│   ├── QC_07.raw
│   ├── QC_08.raw
│   ├── S_01.raw
│   ├── S_02.raw
│   ├── S_03.raw
│   ├── S_04.raw
│   ├── S_05.raw
│   └── S_06.raw
└── POS
    ├── QC_01.raw
    ├── QC_02.raw
    ├── QC_07.raw
    ├── QC_08.raw
    ├── S_01.raw
    ├── S_02.raw
    ├── S_03.raw
    ├── S_04.raw
    ├── S_05.raw
    └── S_06.raw
```

#### **3. Software Usage Instructions**

``` {style="color:black; background-color:#F8F8FF"}
hpc-runTidymass -i 32.CH/ -t 2 -g no -c rp -s 32.CH/sampe_info.txt
```

`-i : input,   The file path of .raw data.`

`-t : type,  The type of ion model, 1: NEG+POS in one file, 2: NEG and POS in differnet files, default: 1.`

`-g : heterogeneous,  samples from different tissues(or species) or not, yes | no, default : no.`

`-c : column,  rp or hilic, default: rp.`

`-s : sample_info,  sample information. see tidymass manual.`

#### **4.Result**

The analysis yielded the following results:

``` {style="color:black; background-color:#F8F8FF"}
./working_dir/
├── 01.data
│   └── rawdata
│       ├── injection_order_neg.txt
│       ├── injection_order_pos.txt
│       ├── mrm_chenhui.xlsx
│       ├── NEG
│       │   ├── QC
│       │   │   ├── QC_01.raw
│       │   │   ├── QC_02.raw
│       │   │   ├── QC_07.raw
│       │   │   └── QC_08.raw
│       │   └── Subject
│       │       ├── S_01.raw
│       │       ├── S_02.raw
│       │       ├── S_03.raw
│       │       ├── S_04.raw
│       │       ├── S_05.raw
│       │       └── S_06.raw
│       ├── POS
│       │   ├── QC
│       │   │   ├── QC_01.raw
│       │   │   ├── QC_02.raw
│       │   │   ├── QC_07.raw
│       │   │   └── QC_08.raw
│       │   └── Subject
│       │       ├── S_01.raw
│       │       ├── S_02.raw
│       │       ├── S_03.raw
│       │       ├── S_04.raw
│       │       ├── S_05.raw
│       │       └── S_06.raw
│       └── sampe_info.txt
├── 02.progress
│   ├── Annotation
│   │   ├── Feature_filtering
│   │   │   ├── 01.Filtered_FeatureAnnotation.xlsx
│   │   │   ├── 02.Filtered_FeatureAccumulationMatrix.xlsx
│   │   │   └── 03.Filtered_Sample_info.xlsx
│   │   ├── NEG -> ../transform/MS2/NEG/
│   │   ├── object_neg_anno.rds
│   │   ├── object_neg.ms2.rds
│   │   ├── object_neg.rds -> ../Data_cleaning/object_neg.rds
│   │   ├── object_pos_anno.rds
│   │   ├── object_pos.ms2.rds
│   │   ├── object_pos.rds -> ../Data_cleaning/object_pos.rds
│   │   ├── Original_annotation
│   │   │   ├── 01.Original_FeatureAnnotation.xlsx
│   │   │   ├── 02.Original_FeatureAccumulationMatrix.xlsx
│   │   │   └── 03.Original_Sample_info.xlsx
│   │   ├── POS -> ../transform/MS2/POS/
│   │   ├── RemoveRedundancy
│   │   │   ├── Final_annotation.xlsx
│   │   │   ├── metadata_deduplicate_cw_method.xlsx
│   │   │   ├── metadata.xlsx
│   │   │   ├── NEG_final_rest.xlsx
│   │   │   ├── Non_redundant_feature.xlsx
│   │   │   └── POS_final_rest.xlsx
│   │   └── semi_annotation
│   │       └── semi_annotation.xlsx
│   ├── Data_cleaning
│   │   ├── 01.raw
│   │   │   ├── NEG
│   │   │   │   ├── missing_value_distribution.pdf
│   │   │   │   ├── missing_value_distribution.png
│   │   │   │   ├── object.neg
│   │   │   │   ├── peak_distribution_plt.neg.pdf
│   │   │   │   ├── peak_distribution_plt.neg.png
│   │   │   │   ├── raw_peak_boxplot.neg.pdf
│   │   │   │   └── raw_peak_boxplot.neg.png
│   │   │   └── POS
│   │   │       ├── missing_value_distribution.pdf
│   │   │       ├── missing_value_distribution.png
│   │   │       ├── object.pos
│   │   │       ├── peak_distribution_plt.pos.pdf
│   │   │       ├── peak_distribution_plt.pos.png
│   │   │       ├── raw_peak_boxplot.pos.pdf
│   │   │       └── raw_peak_boxplot.pos.png
│   │   ├── 02.remove_noise
│   │   │   ├── NEG
│   │   │   │   ├── object.neg.mv
│   │   │   │   ├── plt_mv_remove_noise.neg.pdf
│   │   │   │   ├── plt_mv_remove_noise.neg.png
│   │   │   │   ├── plt_mv_remove_outlier.neg.pdf
│   │   │   │   └── plt_mv_remove_outlier.neg.png
│   │   │   └── POS
│   │   │       ├── object.pos.mv
│   │   │       ├── plt_mv_remove_noise.pos.pdf
│   │   │       ├── plt_mv_remove_noise.pos.png
│   │   │       ├── plt_mv_remove_outlier.pos.pdf
│   │   │       └── plt_mv_remove_outlier.pos.png
│   │   ├── 03.impute_mv
│   │   │   ├── NEG
│   │   │   │   └── object.neg.impute
│   │   │   └── POS
│   │   │       └── object.pos.impute
│   │   ├── 04.normalization
│   │   │   ├── NEG
│   │   │   │   ├── object_inte_neg
│   │   │   │   ├── plt_pca_BandA_norm.pdf
│   │   │   │   ├── plt_pca_BandA_norm.png
│   │   │   │   ├── plt_rsd_BandA.pdf
│   │   │   │   └── plt_rsd_BandA.png
│   │   │   └── POS
│   │   │       ├── object_inte_pos
│   │   │       ├── plt_pca_BandA_norm.pdf
│   │   │       ├── plt_pca_BandA_norm.png
│   │   │       ├── plt_rsd_BandA.pdf
│   │   │       └── plt_rsd_BandA.png
│   │   ├── injection_order_neg.txt -> ../../01.data/rawdata/injection_order_neg.txt
│   │   ├── injection_order_pos.txt -> ../../01.data/rawdata/injection_order_pos.txt
│   │   ├── object.neg -> ../peak_picking/object.neg
│   │   ├── object_neg.rds
│   │   ├── object.pos -> ../peak_picking/object.pos
│   │   ├── object_pos.rds
│   │   └── Rplots.pdf
│   ├── peak_picking
│   │   ├── NEG
│   │   │   └── Result
│   │   │       ├── BPC.pdf
│   │   │       ├── intermediate_data
│   │   │       │   ├── bpc.plot
│   │   │       │   ├── massprocesser_parameters
│   │   │       │   ├── raw_data
│   │   │       │   ├── tic.plot
│   │   │       │   ├── xdata
│   │   │       │   ├── xdata2
│   │   │       │   └── xdata3
│   │   │       ├── object
│   │   │       ├── Peak_table.csv
│   │   │       ├── Peak_table_for_cleaning.csv
│   │   │       ├── RT correction plot.pdf
│   │   │       └── TIC.pdf
│   │   ├── object.neg
│   │   ├── object.pos
│   │   └── POS
│   │       └── Result
│   │           ├── BPC.pdf
│   │           ├── intermediate_data
│   │           │   ├── bpc.plot
│   │           │   ├── massprocesser_parameters
│   │           │   ├── raw_data
│   │           │   ├── tic.plot
│   │           │   ├── xdata
│   │           │   ├── xdata2
│   │           │   └── xdata3
│   │           ├── object
│   │           ├── Peak_table.csv
│   │           ├── Peak_table_for_cleaning.csv
│   │           ├── RT correction plot.pdf
│   │           └── TIC.pdf
│   └── transform
│       ├── MS1
│       │   ├── NEG
│       │   │   ├── QC
│       │   │   │   ├── QC_01.mzXML
│       │   │   │   ├── QC_02.mzXML
│       │   │   │   ├── QC_07.mzXML
│       │   │   │   └── QC_08.mzXML
│       │   │   └── Subject
│       │   │       ├── S_01.mzXML
│       │   │       ├── S_02.mzXML
│       │   │       ├── S_03.mzXML
│       │   │       ├── S_04.mzXML
│       │   │       ├── S_05.mzXML
│       │   │       └── S_06.mzXML
│       │   └── POS
│       │       ├── QC
│       │       │   ├── QC_01.mzXML
│       │       │   ├── QC_02.mzXML
│       │       │   ├── QC_07.mzXML
│       │       │   └── QC_08.mzXML
│       │       └── Subject
│       │           ├── S_01.mzXML
│       │           ├── S_02.mzXML
│       │           ├── S_03.mzXML
│       │           ├── S_04.mzXML
│       │           ├── S_05.mzXML
│       │           └── S_06.mzXML
│       └── MS2
│           ├── NEG
│           │   ├── QC
│           │   │   ├── QC_01.mgf
│           │   │   ├── QC_02.mgf
│           │   │   ├── QC_07.mgf
│           │   │   └── QC_08.mgf
│           │   └── Subject
│           │       ├── S_01.mgf
│           │       ├── S_02.mgf
│           │       ├── S_03.mgf
│           │       ├── S_04.mgf
│           │       ├── S_05.mgf
│           │       └── S_06.mgf
│           └── POS
│               ├── QC
│               │   ├── QC_01.mgf
│               │   ├── QC_02.mgf
│               │   ├── QC_07.mgf
│               │   └── QC_08.mgf
│               └── Subject
│                   ├── S_01.mgf
│                   ├── S_02.mgf
│                   ├── S_03.mgf
│                   ├── S_04.mgf
│                   ├── S_05.mgf
│                   └── S_06.mgf
└── 03.result

52 directories, 154 files
```

The results after peak picking, data cleaning, removing redundancy, and annotation processing are stored at the following path:

``` {style="color:black; background-color:#F8F8FF"}
./working_dir/02.progress/Annotation/RemoveRedundancy/
├── Final_annotation.xlsx
├── metadata_deduplicate_cw_method.xlsx
├── metadata.xlsx
├── NEG_final_rest.xlsx
├── Non_redundant_feature.xlsx
└── POS_final_rest.xlsx

0 directories, 6 files


./working_dir/02.progress/Annotation/semi_annotation/
└── semi_annotation.xlsx

0 directories, 1 file
```

#### **5.Notes**

The Linux version, compared to the ShinyAPP, features fewer configuration parameters and offers simpler and faster operations, making it suitable for projects with more than 30 samples.

If parameter adjustments are needed during the analysis, you can modify the corresponding parameters in the .HPC_tidymass/src/R/ directory.

``` {style="color:black; background-color:#F8F8FF"}
.HPC_tidymass/src/R/
├── 02.PeakPicking.R
├── 04.DataCleaning.R
├── 05.Metabolomics_annotation.R
├── 06.Annotation_filtering.R
├── 06.Annotation_rm_redundancy.R
├── 06.Annotation_rm_redundancy_slide_window.R
├── 07.Annotation_rm_redun_pos_neg.R
├── 08.Annotation_rm_redun_cw.R
├── 09.semi_annotation.R
└── classifiy.R
```

## Usage of ShinyAPP

![Win version](https://img.shields.io/badge/Win-%3E7-greenyellow) ![MacOS version](https://img.shields.io/badge/MacOS-%3E%2010.10-salmon)

### 2 Download ShinyAPP

Open the website <https://github.com/ShawnWx2019/MDAtoolkits-interactive>.

[![](https://pic.imgdb.cn/item/663890380ea9cb140359053e.png)](https://pic.imgdb.cn/item/663890380ea9cb140359053e.png)

Download the Shiny app file (test_allinone_saved.R).

[![](https://pic.imgdb.cn/item/663891320ea9cb14035b33bb.png)](https://pic.imgdb.cn/item/663891320ea9cb14035b33bb.png)

Open the project in RStudio, click on **`Install`** and install the required R packages. After installation is complete, click **`Run App`** to launch the application.

[![](https://pic.imgdb.cn/item/663891930ea9cb14035c09e4.png)](https://pic.imgdb.cn/item/663891930ea9cb14035c09e4.png)

### 3 Upstream analysis

After clicking **`Run App`**, the software interface will open in the default web browser. You will be able to see the analysis functions, workflow, citation information, and more provided by the software, as shown in the following image:

[![](https://pic.imgdb.cn/item/663891c80ea9cb14035c7922.png)](https://pic.imgdb.cn/item/663891c80ea9cb14035c7922.png)

Before starting the project, we need to set up the working directory and upload sample information. <br> **`Start with Ms file`**: If your data is in raw format, you need to first convert it to .mgf format using HPC_tidymass. Then click on 'Start with Ms file' to upload the file. Then upload the folder containing MS2. <br>

[![](https://pic.imgdb.cn/item/6639fce80ea9cb140386eb60.png)](https://pic.imgdb.cn/item/6639fce80ea9cb140386eb60.png)

**`Start with table file`**: If your data is a post-peak metabolite expression matrix, you can click on the 'Start with table file' button to upload the data. The sample table is as follows, and the first four columns must exist, with column names not to be changed. Then upload the folder containing MS2. <br> [![](https://pic.imgdb.cn/item/663a2d880ea9cb1403cdf18f.png)](https://pic.imgdb.cn/item/663a2d880ea9cb1403cdf18f.png)

| variable_id | mz          | rt          | ion | QC_01       | QC_02       | S_0001      | S_0002      |
|---------|---------|---------|---------|---------|---------|---------|---------|
| M70T62_POS  | 70.01316878 | 62.06685067 | pos | 6422973.113 | 6633231.566 | 6660501.932 | 11244650.29 |
| M70T68_POS  | 70.06585079 | 67.5881424  | pos | 10706990.64 | 10460824.98 | 11116669.13 | 6827733.67  |
| M71T62_POS  | 70.51076913 | 62.06355477 | pos | 1199070.522 | 1194094.6   | 961425.2767 | 1901259.45  |
| M71T797_POS | 70.56926299 | 796.6648254 | pos | 261481.9444 | 586260.7111 | 511672.8729 | 545118.6108 |
| M71T923_POS | 70.59889285 | 923.4801941 | pos | 389934.3209 | NA          | 92479.00834 | 256380.4942 |
| M71T792_POS | 70.81124068 | 791.72229   | pos | NA          | 116109.2233 | 215459.5171 | NA          |
| M71T935_POS | 70.99175737 | 934.7305298 | pos | NA          | 2577127.496 | 1839011.277 | NA          |
| M71T763_POS | 71.27096446 | 763.3102417 | pos | 209341.4224 | 243076.9396 | NA          | NA          |
| M71T835_POS | 71.27102179 | 834.5613403 | pos | NA          | 226504.3811 | NA          | NA          |

**`Start with massdataset object`**: If your data is generated by tidymass, you can choose the 'Start with massdataset object' button to upload your data. Then upload the folder containing MS2. [![](https://pic.imgdb.cn/item/663a2cdc0ea9cb1403cd232a.png)](https://pic.imgdb.cn/item/663a2cdc0ea9cb1403cd232a.png) The file structure is as follows.

``` {style="color:black; background-color:#F8F8FF"}
E:/count/test3
├── MS2
│   ├── NEG
│   │   ├── QC
│   │   │   └── QC_001.mgf
│   │   └── Subject
│   └── POS
│       ├── QC
│       │   └── QC_002.mgf
│       └── Subject
├── object.neg.rda
└── object.pos.rda
```

### 3.1 Upload file

#### **3.1.1 Upload sample information**

1.  Set working directory.
2.  Upload sample information file (must be a **.csv** file).
3.  If there are changes in column names when preparing sample information, you can click the dropdown button to correspond to them.
4.  Check sample information.

[![](https://pic.imgdb.cn/item/6639a8d10ea9cb1403f30cdd.png)](https://pic.imgdb.cn/item/6639a8d10ea9cb1403f30cdd.png)

If you have unfinished analyses,you need to upload the previously generated mass_dataset (.rda) files (both positive and negative model), and then select the steps you wish to continue with. The optional steps include **`removing noisy features`**, **`removing outliers`**, **`imputing missing values`**, **`normalization`**, **`annotation`**, and **`annotation filtering`**.

[![](https://pic.imgdb.cn/item/6639f9040ea9cb140380effe.png)](https://pic.imgdb.cn/item/6639f9040ea9cb140380effe.png)

#### **3.1.2 Upload MS file**

Click the dropdown button **`Import file`** and upload MS1, MS2 files, as shown in the structure below. Click the **`1. Check input file`** button to check the data.

[![](https://pic.imgdb.cn/item/6638925d0ea9cb14035db331.png)](https://pic.imgdb.cn/item/6638925d0ea9cb14035db331.png)

### 3.2 Peak picking

After confirming correctness, click the **`2. Peak picking`** button for peak picking. This is a relatively lengthy process, and the progress bar will be displayed in the bottom right corner.

[![](https://pic.imgdb.cn/item/6638927e0ea9cb14035dfbcc.png)](https://pic.imgdb.cn/item/6638927e0ea9cb14035dfbcc.png)

### 3.3 Data cleaning

Data cleaning includes: **`Overview`**, **`Remove noisy features`**, **`Remove outliers`**, **`Missing value imputation`**, and **`Normalization`**.

[![](https://pic.imgdb.cn/item/663a2f830ea9cb1403d0495a.png)](https://pic.imgdb.cn/item/663a2f830ea9cb1403d0495a.png)

#### **3.3.1 Overview**

First, upload sample information and set parameters, then **`Update sample information`**, click **`Start`**, and finally open the **`Interactive plot`** button to check for missing sample data.

[![](https://pic.imgdb.cn/item/663a33c90ea9cb1403d6d1ab.png)](https://pic.imgdb.cn/item/663a33c90ea9cb1403d6d1ab.png)

Open the interactive button, then hover the mouse over the image to see detailed information about the samples in the detailed image.

[![](https://pic.imgdb.cn/item/663a38680ea9cb1403ddb41a.png)](https://pic.imgdb.cn/item/663a38680ea9cb1403ddb41a.png)

#### **3.3.2 Remove noisy features**

First, adjust the parameters for grouping, samples, and QC missing frequency on the left side, click **`Find noisy features`** to identify noisy features, and then click **`Remove and update`** to update the data.

[![](https://pic.imgdb.cn/item/663892d00ea9cb14035eb0d4.png)](https://pic.imgdb.cn/item/663892d00ea9cb14035eb0d4.png)

#### **3.3.3 Remove outliers**

First, adjust the parameters on the left side, click **`Find outliers`** to identify outliers, open the **`Interactive plot`**, hover the mouse over the outlier sample to view outlier sample information, remove outlier values. Then switch to negative spectrum and repeat the operation, then click **`Remove and update`** to update the data.

[![](https://pic.imgdb.cn/item/663a3f8a0ea9cb1403e81801.png)](https://pic.imgdb.cn/item/663a3f8a0ea9cb1403e81801.png)

#### **3.3.4 Missing value imputation**

Select the method for missing value imputation, such as: knn, rf, mean, median, zero, mininum, bpca, svdlmpute, ppca, etc., click **`Start`** to proceed with imputation.

[![](https://pic.imgdb.cn/item/6638930f0ea9cb14035f3f76.png)](https://pic.imgdb.cn/item/6638930f0ea9cb14035f3f76.png)

#### **3.3.5 Data standardization**

First, adjust the method for filling missing values on the left side, such as svr, total, mean,median, pqn, loess ppca, etc., click **`Start normalization`** to standardize the data. Select PCA color grouping. Then click **`Visualize`** to visualize the data before and after normalization. Open the **`Interactive plot`** button, and you can see the 3D PCA plot. Hovering the mouse over it allows you to see detailed information about the samples. Finally, click the **`Export normalized data`** button to download the normalized data.

[![](https://pic.imgdb.cn/item/663aee480ea9cb1403e13554.png)](https://pic.imgdb.cn/item/663aee480ea9cb1403e13554.png)

[![](https://pic.imgdb.cn/item/663aeda60ea9cb1403dff9d3.png)](https://pic.imgdb.cn/item/663aeda60ea9cb1403dff9d3.png)
